<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Google Calendar</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            flex-direction: column;
        }
        #calendar-container {
            width: 100%;
            max-width: 1200px;
            margin: 20px;
        }
        #signin-button {
            margin-bottom: 20px;
        }
    </style>
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <script>
        let clientId = 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com'; // Replace with your client ID
        let accessToken = '';
        let userEmail = ''; // To store logged-in user's email

        // Handle response from Google Sign-In
        function handleCredentialResponse(response) {
            const user = response.credential;
            const userInfo = JSON.parse(atob(user.split('.')[1]));
            userEmail = userInfo.email;  // Get email from JWT

            console.log('Logged in as: ', userEmail);
            console.log('Access Token:', response.credential); // Log the access token

            // Store the access token for API requests
            accessToken = response.credential;

            // After login, load the user's calendar
            loadCalendarEvents();
        }

        // Load the calendar events
        function loadCalendarEvents() {
            if (!accessToken) {
                console.log("No access token found. Please authenticate.");
                return;
            }

            // Load the Google API client
            gapi.load('client:auth2', initCalendarClient);
        }

        // Initialize Google Calendar API client
        function initCalendarClient() {
            console.log('Initializing Google Calendar client...');
            gapi.auth2.init({ client_id: clientId }).then(() => {
                gapi.client.load('https://content.googleapis.com/discovery/v1/apis/calendar/v3/rest').then(() => {
                    getCalendarEvents();
                }).catch(error => {
                    console.error('Error loading Google Calendar API:', error);
                });
            }).catch(error => {
                console.error('Error initializing Google Auth:', error);
            });
        }

        // Fetch the logged-in user's calendar events
        function getCalendarEvents() {
            if (!accessToken) {
                console.log("No access token found.");
                return;
            }

            // Use the logged-in user's email to display their calendar
            console.log('Fetching calendar events for:', userEmail);  // Log the user email
            gapi.client.request({
                path: `https://www.googleapis.com/calendar/v3/calendars/${userEmail}/events`,  // Use the logged-in user's email
                method: 'GET',
                params: {
                    access_token: accessToken
                }
            }).then(response => {
                console.log('Calendar events response:', response);  // Log the response to check if the API returns events
                if (response.result.items && response.result.items.length > 0) {
                    // If events are found, display them
                    const calendarUrl = `https://calendar.google.com/calendar/embed?src=${encodeURIComponent(userEmail)}&ctz=America%2FSao_Paulo`;
                    createCalendarIframe(calendarUrl);
                } else {
                    console.log('No events found in the calendar.');
                    document.getElementById('calendar-container').innerHTML = '<p>No upcoming events found.</p>';
                }
            }).catch(error => {
                console.error('Error fetching calendar events:', error);
            });
        }

        // Create and embed the calendar iframe
        function createCalendarIframe(calendarUrl) {
            const iframe = document.createElement('iframe');
            iframe.src = calendarUrl;
            iframe.style = "border: 0";
            iframe.width = "800";
            iframe.height = "600";
            iframe.frameBorder = "0";
            iframe.scrolling = "no";
            
            // Clear the previous content and append the new iframe
            document.getElementById('calendar-container').innerHTML = '';
            document.getElementById('calendar-container').appendChild(iframe);
        }

        // Initialize Google Sign-In
        function initGoogleSignIn() {
            if (typeof google === 'undefined') {
                // Retry initialization once the Google API is available
                setTimeout(initGoogleSignIn, 100);
                return;
            }

            google.accounts.id.initialize({
    client_id: clientId,
    callback: handleCredentialResponse,
    scope: 'https://www.googleapis.com/auth/calendar'  // Request read/write permissions
});

            google.accounts.id.renderButton(
                document.getElementById('signin-button'),
                { theme: 'outline', size: 'large' }
            );
        }

        // Initialize Google Sign-In after the window is loaded and the script is available
        window.onload = function() {
            initGoogleSignIn();
        };
    </script>
</head>
<body>
    <div id="signin-button"></div> <!-- Google Sign-In button -->
    <div id="calendar-container">
        <!-- Calendar will be dynamically embedded here -->
    </div>
</body>
</html>
